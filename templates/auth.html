{% extends "base.html" %}
{% block title %}Authentication - HR Analysis System{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-5 fade-in-up">

            <!-- Login Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white text-center">
                    <h3 class="mb-0"><i class="fas fa-user-lock me-2"></i>Login</h3>
                </div>
                <div class="card-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="loginEmail" required autocomplete="email">
                        </div>

                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required autocomplete="current-password">
                        </div>

                        <div class="d-grid mb-3">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-sign-in-alt me-2"></i>Login
                            </button>
                        </div>
                    </form>

                    <div class="text-center mt-3">
                        <small class="text-muted">Or login with:</small>

                        <div class="d-flex justify-content-center mt-3 gap-2">
                            <a href="/login/google" class="btn btn-outline-danger">
                                <i class="fab fa-google me-1"></i> Google
                            </a>
                            <a href="/login/github" class="btn btn-outline-dark">
                                <i class="fab fa-github me-1"></i> GitHub
                            </a>
                            <a href="/login/linkedin" class="btn btn-outline-primary">
                                <i class="fab fa-linkedin me-1"></i> LinkedIn
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Register Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white text-center">
                    <h3 class="mb-0"><i class="fas fa-user-plus me-2"></i>Register</h3>
                </div>
                <div class="card-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="firstName" required autocomplete="given-name">
                        </div>

                        <div class="mb-3">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="lastName" required autocomplete="family-name">
                        </div>

                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="registerEmail" required autocomplete="email">
                        </div>

                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="registerPassword" required autocomplete="new-password">
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-user-plus me-2"></i>Register
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Error box -->
            <div id="authError" class="alert alert-danger mt-3 d-none">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span id="errorMessage"></span>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/* ------------------------------------------------------
   Helper to fetch with CSRF header for /refresh
------------------------------------------------------ */
function getCSRFToken() {
    const name = "csrf_token=";
    const decoded = decodeURIComponent(document.cookie);
    const parts = decoded.split(';');
    for (let p of parts) {
        let c = p.trim();
        if (c.indexOf(name) === 0) return c.substring(name.length, c.length);
    }
    return null;
}

/* ------------------------------------------------------
   Error handler
------------------------------------------------------ */
function showError(message) {
    document.getElementById("errorMessage").textContent = message;
    document.getElementById("authError").classList.remove("d-none");
}

/* ------------------------------------------------------
   Universal handler for login & register
------------------------------------------------------ */
async function handleAuth(endpoint, payload) {
    try {
        const res = await fetch(endpoint, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Requested-With": "XMLHttpRequest"
            },
            body: JSON.stringify(payload)
        });

        const data = await res.json();


        if (res.ok && data.access_token) {
            sessionStorage.setItem("access_token", data.access_token);
            window.location.replace("/");
        } else {
            showError(data.error || "Authentication failed");
        }

    } catch (err) {
        showError("Network error: " + err.message);
    }
}

/* ------------------------------------------------------
   Forms
------------------------------------------------------ */
document.getElementById("loginForm").addEventListener("submit", e => {
    e.preventDefault();
    handleAuth("/login", {
        email: document.getElementById("loginEmail").value,
        password: document.getElementById("loginPassword").value
    });
});

document.getElementById("registerForm").addEventListener("submit", e => {
    e.preventDefault();
    handleAuth("/register", {
        first_name: document.getElementById("firstName").value,
        last_name: document.getElementById("lastName").value,
        email: document.getElementById("registerEmail").value,
        password: document.getElementById("registerPassword").value
    });
});
</script>
{% endblock %}

{% block styles %}
<style>
.card {
    border-radius: 12px;
    transition: all 0.28s ease;
}
.card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 28px rgba(0,0,0,0.15) !important;
}
.btn-lg {
    padding: 12px 24px;
    font-size: 1.1rem;
    border-radius: 10px;
}
.form-control {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    transition: all 0.25s ease;
}
.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.25);
}
.fade-in-up {
    animation: fadeInUp 0.6s ease-out;
}
@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}
.btn-outline-danger:hover {
    color: white !important;
}
</style>
{% endblock %}